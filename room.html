<!doctype html>
<html lang="vi" data-bs-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TẬP HUẤN XÂY DỰNG HỌC LIỆU SỐ CHO GIẢNG VIÊN, GIÁO VIÊN CÁC HỌC VIỆN, TRƯỜNG QUÂN ĐỘI</title>

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
    <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />

  <link rel="stylesheet" href="./style/style.css">
  
</head>
<body>
  <main class="">
    
    <section class="main">
      <div class="container my-4 ">
    <div class="welcome">
        <!-- <h2>NHIỆT LIỆT CHÀO MỪNG CÁC ĐỒNG CHÍ<br>VỀ DỰ LỚP TẬP HUẤN XÂY DỰNG HỌC LIỆU SỐ<br>CHO GIẢNG VIÊN, GIÁO VIÊN CÁC HỌC VIỆN,<br>TRƯỜNG TRONG QUÂN ĐỘI</h2> -->
        <img src="./images/chao-1.gif" alt="welcome image" class="w-100" style="position: relative;">
    </div>
    <div class="information mb-3">
        <div class="content">
            <span>Thời gian:</span>
            <p>Từ ngày 25 đến 27/8/2025</p>
        </div>
        <div class="img-bottom">
            <img src="./images/bottom.webp" alt="image">
        </div>
    </div>
     <div class="information">
        <div class="content">
            <span>Địa điểm:</span>
            <p>Trung tâm Công nghệ thông tin và Ngoại ngữ, Trường Sĩ quan Thông tin</p>
        </div>
        <div class="img-bottom">
            <img src="./images/bottom.webp" alt="image">
        </div>
    </div>
    <div class="title">
      <h1>Check-in nhận phòng</h1>
    </div>
    

    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <form class="row gy-3 gx-2 align-items-end" onsubmit="return false;">
          <div class="col-12 col-md-8">
            <label for="hoten" class="form-label fw-semibold">Họ và tên</label>
            <input id="hoten" type="text" class="form-control"
                   placeholder="Nhập họ tên (có/không dấu đều được)">
            <div class="form-text">Mẹo: gõ “Nguyen Van A” vẫn khớp “Nguyễn Văn A”.</div>
          </div>
          <div class="col-12 col-md-4 d-grid">
            <button id="btn" type="button" class="btn btn-primary">
              Xem phòng
            </button>
          </div>
        </form>

        <div id="status" class="mt-3"></div>
      </div>
    </div>

    <div id="result" class="card shadow-sm d-none">
      <div class="card-body" id="resultBody"></div>
    </div>
    </div>
    </section>
    <section class="faq" style="max-width: 480px; margin: auto;">
      <div class="container py-4">
        <div class="box-image mb-5">
          <h3 data-aos="fade-up" data-aos-duration="3000">VỊ TRÍ TÒA NHÀ</h3>
        <div class="location" data-aos="fade-up" data-aos-duration="3000">
          <img src="./images/location.png" alt="location" class="w-100">
        </div>
        </div>
        <div class="organization  mb-3" data-aos="fade-right" data-aos-duration="3000">
        <h4>ĐƠN VỊ TỔ CHỨC</h4>
        <P>Cục Quân huấn - Nhà trường</br>(Bộ Tổng Tham mưu)</P>
      </div>
      <div class="organization mb-3" data-aos="fade-left" data-aos-duration="3000">
        <h4>ĐƠN VỊ THỰC HIỆN</h4>
        <P>Trung tâm Công nghệ thông tin và Ngoại ngữ, Trường Sĩ quan Thông tin</P>
      </div>
      </div>
      
    </section>
    <section class="contact py-4" style="max-width: 480px; margin: auto;     text-align: center; ">
      <div class="container">
        <a href="tel:0984577788" data-aos="flip-up" data-aos-duration="3000">SĐT Ban tổ chức: 0984577788</a>
      </div>
    </section>
    <footer style="max-width: 480px; margin: auto;">
      <div class="container">
        <div class="copyright"><span>© 2025 - Developed by Mitech Center</span></div>
      </div>
    </footer>
  </main>

  <!-- Bootstrap JS (for dropdowns, etc.) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
   <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
  <script>
    AOS.init();
  </script>
  <script>
    // ======= CẤU HÌNH =======
    // Thay bằng URL /exec của Apps Script (ví dụ: https://script.google.com/macros/s/XXXX/exec)
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwOE48nkSqrgW_MG3AuiLT3Wf9oT6T4oN4QxiRAvkSptxMcEuhPREt5qWV3K2NsKQ/exec";

    // ======= TIỆN ÍCH =======
    const $ = (id) => document.getElementById(id);
    const escapeHTML = (s) => String(s ?? "")
      .replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

    // JSONP để tránh CORS
    function jsonp(url){
      return new Promise((resolve, reject) => {
        const cb = "cb_room_" + Date.now() + "_" + Math.random().toString(36).slice(2);
        window[cb] = (data) => { cleanup(); resolve(data); };
        function cleanup(){ try{ delete window[cb]; }catch(_){} s.remove(); }
        const s = document.createElement("script");
        s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
        s.onerror = () => { cleanup(); reject(new Error("Network error")); };
        document.body.appendChild(s);
      });
    }

    // ======= RENDER =======
    function alertElem(kind, html){
      return `<div class="alert alert-${kind} mb-0" role="alert">${html}</div>`;
    }

    function renderFound(entry){
      return `
        <div class="alert alert-success" role="alert">
          <strong>Đã tìm thấy phòng của bạn.</strong>
        </div>
        <div class="table-responsive mt-3">
          <table class="table table-bordered align-middle">
            <tbody>
              <tr><th style="width: 80px;">Họ tên</th><td>${escapeHTML(entry.hoten)}</td></tr>
              <tr><th>Đơn vị</th><td>${escapeHTML(entry.donvi || "-")}</td></tr>
              <tr><th>Phòng</th><td class="room fs-5" style="font-size: 16px !important;">${escapeHTML(entry.room || "-")}</td></tr>
            </tbody>
          </table>
        </div>
      `;
    }

    function renderMulti(matches){
      return `
        <div class="alert alert-warning" role="alert">
          Có nhiều người trùng tên, vui lòng đối chiếu đúng người.
        </div>
        <div class="table-responsive table-wrap mt-3">
          <table class="table table-striped table-hover align-middle">
            <thead class="table-light">
              <tr><th>Họ tên</th><th>Đơn vị</th><th>Phòng</th></tr>
            </thead>
            <tbody>
              ${matches.map(m => `
                <tr>
                  <td>${escapeHTML(m.hoten)}</td>
                  <td>${escapeHTML(m.donvi || "-")}</td>
                  <td class="room">${escapeHTML(m.room || "-")}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      `;
    }

    // Lưu dữ liệu toàn bộ để lọc
    window.__ALL_ROWS = [];

    function renderList(groups){
      if(!groups || !groups.length) {
        return alertElem("secondary", "Chưa có dữ liệu phòng.");
      }

      // Chuẩn hoá -> 1 mảng dòng
      const rows = [];
      groups.forEach(g => {
        const room = g.room || "-";
        (g.people || []).forEach(p => rows.push({
          hoten: p.hoten || "",
          donvi: p.donvi || "",
          room
        }));
      });
      window.__ALL_ROWS = rows;

      // Danh sách đơn vị duy nhất
      const units = Array.from(new Set(rows.map(r => r.donvi || "(trống)")))
                         .sort((a,b)=>a.localeCompare(b,"vi"));

      return `
        ${alertElem("danger","<strong>Không thấy tên trong danh sách.</strong> Dưới đây là toàn bộ danh sách để tra cứu.")}

        <div class="row g-2 align-items-center mt-3">
          <div class="col-auto">
            <label for="unitFilter" class="col-form-label">Đơn vị:</label>
          </div>
          <div class="col-12 col-md-4">
            <select id="unitFilter" class="form-select select-arrow-white">
              <option value="">Tất cả đơn vị</option>
              ${units.map(u => `<option value="${escapeHTML(u)}">${escapeHTML(u)}</option>`).join("")}
            </select>
          </div>
          <div class="col-auto">
            <button id="clearFilter" class="btn btn-outline-secondary">Xóa lọc</button>
          </div>
        </div>

        <div class="table-responsive table-wrap mt-3">
          <table class="table table-striped table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Họ tên</th>
                <th>Đơn vị</th>
                <th>Phòng</th>
              </tr>
            </thead>
            <tbody id="listTbody"></tbody>
          </table>
          <div class="text-secondary small" id="listFooter"></div>
        </div>
      `;
    }

    function applyUnitFilter(){
      const all = window.__ALL_ROWS || [];
      const sel = $("unitFilter");
      const unit = sel ? sel.value : "";
      const tbody = $("listTbody");
      const foot = $("listFooter");

      const data = all.filter(r => !unit || (r.donvi || "(trống)") === unit);
      data.sort((a,b)=> a.hoten.localeCompare(b.hoten,"vi") || a.room.localeCompare(b.room,"vi"));

      tbody.innerHTML = data.map(r => `
        <tr>
          <td>${escapeHTML(r.hoten)}</td>
          <td>${escapeHTML(r.donvi || "(trống)")}</td>
          <td class="room">${escapeHTML(r.room)}</td>
        </tr>
      `).join("");

      foot.textContent = `Hiển thị ${data.length}/${all.length} người` + (unit ? ` • Đơn vị: ${unit}` : "");
    }

    function attachListHandlers(){
      const sel = $("unitFilter");
      const clr = $("clearFilter");
      if(sel) sel.addEventListener("change", applyUnitFilter);
      if(clr) clr.addEventListener("click", () => { sel.value = ""; applyUnitFilter(); });
      applyUnitFilter();
    }

    // ======= TƯƠNG TÁC =======
    const btn = $("btn");
    const input = $("hoten");
    const status = $("status");
    const card = $("result");
    const cardBody = $("resultBody");

    function setLoading(on){
      if(on){
        btn.dataset.text = btn.innerHTML;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Đang xử lý…`;
        btn.disabled = true;
      }else{
        btn.innerHTML = btn.dataset.text || "Xem phòng";
        btn.disabled = false;
      }
    }

    async function handleSearch(){
      const name = input.value.trim();
      card.classList.add("d-none");
      cardBody.innerHTML = "";
      if(!name){
        status.innerHTML = alertElem("danger","Vui lòng nhập họ tên.");
        return;
      }
      status.innerHTML = "";
      setLoading(true);

      try{
        const url = `${GAS_URL}?action=room&hoten=${encodeURIComponent(name)}&t=${Date.now()}`;
        const r = await jsonp(url);

        if(!r || r.ok !== true){
          status.innerHTML = alertElem("danger", escapeHTML(r && r.error ? r.error : "Không gọi được API"));
          return;
        }

        if(r.mode === "FOUND"){
          cardBody.innerHTML = renderFound(r.entry);
          card.classList.remove("d-none");
        } else if(r.mode === "MULTI"){
          cardBody.innerHTML = renderMulti(r.matches || []);
          card.classList.remove("d-none");
        } else { // LIST
          cardBody.innerHTML = renderList(r.rooms || []);
          card.classList.remove("d-none");
          attachListHandlers();
        }
      } catch(err){
        status.innerHTML = alertElem("danger", "Lỗi mạng: " + escapeHTML(err.message));
      } finally {
        setLoading(false);
      }
    }

    btn.addEventListener("click", handleSearch);
    input.addEventListener("keydown", (e) => { if(e.key === "Enter") handleSearch(); });

    // Prefill từ query: ?name=... hoặc ?hoten=...
    (function prefill(){
      const q = new URLSearchParams(location.search);
      const v = q.get("name") || q.get("hoten");
      if(v){ input.value = v; }
    })();
  </script>
</body>
</html>
